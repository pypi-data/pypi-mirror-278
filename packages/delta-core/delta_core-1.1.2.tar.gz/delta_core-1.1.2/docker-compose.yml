volumes:
  delta-run-db: {}

services:
  db:
    container_name: delta-run-db
    image: postgres:16
    environment:
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_DATABASE}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - delta-run-db:/var/lib/postgresql/data/
    healthcheck:
      test: [ "CMD-SHELL", "sh -c 'pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}'" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  delta-run:
    container_name: delta-run
    depends_on:
      db:
        condition: service_healthy
    build:
      context: .
    image: "registry.gael.fr/gael10/delta/software/delta-core/delta-run:dev"
    environment:
      DELTA_API_URL: ${DELTA_API_URL}
      REGISTRY_URL: ${REGISTRY_URL}
      REGISTRY_USERNAME: ${REGISTRY_USERNAME}
      REGISTRY_PASSWORD: ${REGISTRY_PASSWORD}
      STORAGE_S3_ENDPOINT: ${STORAGE_S3_ENDPOINT}
      STORAGE_S3_REGION: ${STORAGE_S3_REGION}
      STORAGE_S3_ACCESS_KEY: ${STORAGE_S3_ACCESS_KEY}
      STORAGE_S3_SECRET_ACCESS_KEY: ${STORAGE_S3_SECRET_ACCESS_KEY}
      STORAGE_S3_BUCKET: ${STORAGE_S3_BUCKET}
      EXEC_K8S_CONTEXT: ${EXEC_K8S_CONTEXT}
      EXEC_K8S_NAMESPACE: ${EXEC_K8S_NAMESPACE}
      EXEC_K8S_CLUSTER_NAME: ${EXEC_K8S_CLUSTER_NAME}
      EXEC_K8S_CLUSTER_CERT_AUTH: ${EXEC_K8S_CLUSTER_CERT_AUTH}
      EXEC_K8S_CLUSTER_SERVER: ${EXEC_K8S_CLUSTER_SERVER}
      EXEC_K8S_USER_NAME: ${EXEC_K8S_USER_NAME}
      EXEC_K8S_USER_CLI_CERT: ${EXEC_K8S_USER_CLI_CERT}
      EXEC_K8S_USER_CLI_KEY: ${EXEC_K8S_USER_CLI_KEY}
      EVICTION_ACTIVE: ${EVICTION_ACTIVE}
      EVICTION_THRESHOLD_HOURS: ${EVICTION_THRESHOLD_HOURS}
      DATABASE_URL: postgresql+${DB_DRIVER}://${DB_USERNAME}:${DB_PASSWORD}@db/${DB_DATABASE}
      # SHOW_SQL_QUERIES: True
    ports:
      - "8000:8000"