---
build-packages:
  artifacts:
    expire_in: 1 week
    paths:
      - dist/
      - build_harness.log
      - release_flow.log
    when: always
  extends: .python-image
  stage: package
  variables:
    python_version: "${DEFAULT_PYTHON_VERSION}"

  script:
    - ${VENV_BIN}/pip uninstall -y click_logging_config
    - ${VENV_BIN}/pip install .
    - echo "${CI_DEFAULT_BRANCH}"
    - ${VENV_BIN}/release-flow --version
    - |
      echo $(${VENV_BIN}/release-flow \
        --log-console-enable \
        --log-file-enable \
        --log-level ${BUILDHARNESS_LOG_LEVEL} \
        --default-branch "${CI_DEFAULT_BRANCH}")
    - |
      export THIS_VERSION=$(${VENV_BIN}/release-flow \
      --log-console-disable \
      --log-file-enable \
      --log-level ${BUILDHARNESS_LOG_LEVEL} \
      --default-branch "${CI_DEFAULT_BRANCH}")
    # log THIS_VERSION to pipeline log for debugging
    - echo "${THIS_VERSION}"
    - |
      ${VENV_BIN}/build-harness \
        --log-console-disable \
        --log-file-enable \
        --log-level ${BUILDHARNESS_LOG_LEVEL} \
        package \
          --release-id "${THIS_VERSION}"


install-check:
  extends: .python-image
  needs:
    - job: build-packages
      artifacts: true
  stage: tests
  variables:
    python_version: "${DEFAULT_PYTHON_VERSION}"

  script:
    - ls -l dist/
    - ${VENV_BIN}/pip install dist/${PACKAGE_NAME}*.whl
