---
publish-packages:
  artifacts:
    expire_in: 1 week
    paths:
      - build_harness.log
      - publish_flow.log
    when: on_failure
  extends: .python-image
  needs:
    - job: build-packages
      artifacts: true
  stage: publish
  variables:
    python_version: "${DEFAULT_PYTHON_VERSION}"

  script:
    - ${VENV_BIN}/pip uninstall -y click_logging_config
    - ${VENV_BIN}/pip install .
    - echo "${CI_DEFAULT_BRANCH}"
    - echo "${CI_COMMIT_BRANCH}"
    - echo "${CI_COMMIT_REF_NAME}"
    - |
      if [ "${CI_PIPELINE_SOURCE}" == "merge_request_event" ] || [[ "${CI_COMMIT_BRANCH}" =~ ^feature/ ]]; then \
        export PUBLISH_THIS="dryrun"; \
      elif [ "${CI_COMMIT_BRANCH}" == "${CI_DEFAULT_BRANCH}" ]; then \
        export PUBLISH_THIS="yes"; \
      else \
        export PUBLISH_THIS=$( \
          ${VENV_BIN}/publish-flow \
            --log-console-disable \
            --log-file-enable \
            --log-level ${BUILDHARNESS_LOG_LEVEL} \
            --default-branch "${CI_DEFAULT_BRANCH}" \
            --disable-pr-publish "${CI_PIPELINE_SOURCE}" \
            --publish-prerelease \
        ); \
      fi
    # log PUBLISH_THIS to pipeline log for debugging
    - echo ${PUBLISH_THIS}
    # NOTE: using the `--password` option to read from environment variable as
    # this is the most likely to be available in a CI system (but not
    # necessarily the most secure).
    - |
      ${VENV_BIN}/build-harness \
        --log-console-enable \
        --log-file-enable \
        --log-level ${BUILDHARNESS_LOG_LEVEL} \
        publish \
          --user $PYPI_API_USER \
          --password $PYPI_API_TOKEN \
          --publish ${PUBLISH_THIS}
